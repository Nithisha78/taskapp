<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Tasks</title>

    <style>
        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #ffffff;
            color: #111827;
        }

        main { padding: 20px 32px 40px; }


        .top-bar {
            max-width: 1100px;
            margin: 0 auto 28px;
            display: flex;
            justify-content: flex-end;
        }

        .calendar-btn {
            padding: 12px 22px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            color: white;
            font-weight: 800;
            font-size: 15px;
            cursor: pointer;
            box-shadow: 0 8px 18px rgba(79,70,229,0.35);
        }


        .calendar-wrapper {
            max-width: 900px;
            margin: 0 auto 32px;
            padding: 18px;
            border-radius: 20px;
            background: #ffffff;
            box-shadow: 0 12px 26px rgba(0,0,0,0.12);
            display: none;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .calendar-header h3 {
            margin: 0;
            font-size: 17px;
            font-weight: 800;
        }

        .calendar-header button {
            padding: 8px 14px;
            border-radius: 12px;
            border: none;
            font-weight: 800;
            cursor: pointer;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .day-name {
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            color: #6b7280;
        }

        .calendar-day {
            min-height: 85px;
            padding: 8px;
            border-radius: 12px;
            background: #f9fafb;
            font-size: 12px;
            box-shadow: inset 0 0 0 1px #e5e7eb;
        }

        .calendar-day strong {
            font-size: 13px;
            display: block;
            margin-bottom: 6px;
        }

        .calendar-task {
            background: #eef2ff;
            border-radius: 8px;
            padding: 4px 6px;
            margin-bottom: 4px;
            font-size: 11px;
        }


        .controls {
            max-width: 1100px;
            margin: 0 auto 36px;
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 22px;
            border-radius: 20px;
            background: #ffffff;
            box-shadow: 0 10px 24px rgba(0,0,0,0.08);
        }

        .controls input,
        .controls select {
            padding: 11px 18px;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            font-size: 14px;
        }

        .btn-primary {
            padding: 11px 22px;
            border-radius: 999px;
            border: none;
            background: #4f46e5;
            color: white;
            font-weight: 700;
        }

        .btn-secondary {
            padding: 11px 22px;
            border-radius: 999px;
            background: #eef2ff;
            color: #4f46e5;
            font-weight: 700;
            text-decoration: none;
        }


        .task-list {
            max-width: 1200px;
            margin: auto;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 26px;
        }

        .task-card {
            padding: 24px;
            border-radius: 22px;
            background: #e6dcff;
            box-shadow: 0 10px 24px rgba(0,0,0,0.14);
        }

        .task-card.completed {
            background: #f4f1ff;
            opacity: 0.95;
        }

        .title { font-size: 17px; font-weight: 800; }
        .description { font-size: 14px; margin-bottom: 10px; color: #374151; }
        .meta { font-size: 13px; margin-bottom: 4px; color: #6b7280; }

        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            background: rgba(255,255,255,0.7);
            margin-right: 6px;
        }

        .actions {
            margin-top: 14px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .actions a {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 999px;
            font-weight: 700;
            background: #ffffff;
            color: #4f46e5;
            text-decoration: none;
        }


        .pagination {
            margin-top: 44px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .pagination a {
            padding: 10px 18px;
            background: #eef2ff;
            color: #4f46e5;
            border-radius: 999px;
            text-decoration: none;
            font-weight: 700;
        }

        .pagination a.active {
            background: #4f46e5;
            color: white;
        }

.export-dropdown {
    position: relative;
    display: inline-block;
}

.export-dropdown-menu {
    display: none;
    position: absolute;
    top: 48px;
    right: 0;
    background: #ffffff;
    border-radius: 14px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    min-width: 180px;
    z-index: 10;
}

.export-dropdown-menu a {
    display: block;
    padding: 12px 16px;
    text-decoration: none;
    color: #4f46e5;
    font-weight: 700;
    font-size: 14px;
}

.export-dropdown-menu a:hover {
    background: #eef2ff;
    border-radius: 14px;
}

.export-dropdown.show .export-dropdown-menu {
    display: block;
}

    </style>
</head>

<body>

<div th:replace="fragments/header :: header"></div>

<main>


    <div class="top-bar">
        <button class="calendar-btn" onclick="toggleCalendar()">ðŸ“… Calendar</button>
    </div>


    <div class="calendar-wrapper" id="calendarWrapper">
        <div class="calendar-header">
            <button onclick="changeMonth(-1)">â—€</button>
            <h3 id="monthTitle"></h3>
            <button onclick="changeMonth(1)">â–¶</button>
        </div>

        <div class="calendar-grid" id="calendarGrid">
            <div class="day-name">Sun</div>
            <div class="day-name">Mon</div>
            <div class="day-name">Tue</div>
            <div class="day-name">Wed</div>
            <div class="day-name">Thu</div>
            <div class="day-name">Fri</div>
            <div class="day-name">Sat</div>
        </div>
    </div>


    <div class="controls">
        <form action="/tasks/search" method="get">
            <input type="text" name="keyword" placeholder="Search task">
            <button class="btn-primary">Search</button>
        </form>

        <form action="/tasks/filter/status" method="get">
            <select name="status" onchange="this.form.submit()">
                <option value="" disabled selected>Status</option>
                <option value="PENDING">Pending</option>
                <option value="IN_PROGRESS">In Progress</option>
                <option value="COMPLETED">Completed</option>
            </select>

        </form>

        <form action="/tasks/filter/priority" method="get">
            <select name="priority" onchange="this.form.submit()">
                <option value="" disabled selected>Priority</option>
                <option value="LOW">Low</option>
                <option value="MEDIUM">Medium</option>
                <option value="HIGH">High</option>
            </select>

        </form>

        <a href="/tasks" class="btn-secondary">Clear Filters</a>
        <div class="export-dropdown">
            <button class="btn-secondary" onclick="toggleExportDropdown(event)">
                Export CSV â–¼
            </button>

            <div class="export-dropdown-menu">
                <a href="/tasks/export">Download CSV</a>
                <a href="/tasks/export/email">Get CSV on Email</a>

            </div>
        </div>

    </div>


    <div class="task-list">
        <div class="task-card"
             th:each="task : ${tasks}"
             th:classappend="${task.status.name() == 'COMPLETED'} ? 'completed'">

            <div class="title" th:text="${task.title}"></div>
            <div class="description" th:text="${task.description}"></div>

            <div class="meta">
                Due date: <b th:text="${task.dueDate}"></b>
            </div>

            <div class="meta">
                Created at:
                <b th:text="${#temporals.format(task.createdAt, 'dd-MM-yyyy HH:mm')}"></b>
            </div>

            <div class="meta" th:if="${task.completedAt != null}">
                Completed at:
                <b th:text="${#temporals.format(task.completedAt, 'dd-MM-yyyy HH:mm')}"></b>
            </div>


            <span class="badge" th:text="${task.status}"></span>
            <span class="badge" th:text="${task.priority}"></span>

            <div class="actions">
                <a th:if="${task.status.name() != 'COMPLETED'}"
                   th:href="@{'/tasks/complete/' + ${task.id}}">Complete</a>
                <a th:href="@{'/tasks/view/' + ${task.id}}">View</a>
                <a th:if="${task.status.name() != 'COMPLETED'}"
                   th:href="@{'/tasks/edit/' + ${task.id}}">Edit</a>
                <a th:href="@{'/tasks/delete/' + ${task.id}}"
                   onclick="return confirm('Delete this task?')">Delete</a>
            </div>

            <span class="task-data"
                  th:data-date="${task.dueDate}"
                  th:data-title="${task.title}"
                  style="display:none"></span>
        </div>
    </div>

    <div class="pagination">
        <a th:if="${currentPage > 0}"
           th:href="@{'/tasks?page=' + ${currentPage - 1}}">
            Prev
        </a>

        <a th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
           th:href="@{'/tasks?page=' + ${i}}"
           th:text="${i + 1}"
           th:classappend="${i == currentPage} ? 'active'">
        </a>

        <a th:if="${currentPage < totalPages - 1}"
           th:href="@{'/tasks?page=' + ${currentPage + 1}}">
            Next
        </a>
    </div>

</main>

<div th:replace="fragments/footer :: footer"></div>

<script>
    let currentDate = new Date();

   function toggleCalendar() {
    const cal = document.getElementById("calendarWrapper");
    if (cal.style.display === "block") {
        cal.style.display = "none";
    } else {
        cal.style.display = "block";
        renderCalendar();
    }
}


    function changeMonth(step) {
        currentDate.setMonth(currentDate.getMonth() + step);
        renderCalendar();
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        const monthNames = [
            "January","February","March","April","May","June",
            "July","August","September","October","November","December"
        ];

        document.getElementById("monthTitle").innerText =
            monthNames[month] + " " + year;

        const grid = document.getElementById("calendarGrid");
        grid.innerHTML = `
            <div class="day-name">Sun</div>
            <div class="day-name">Mon</div>
            <div class="day-name">Tue</div>
            <div class="day-name">Wed</div>
            <div class="day-name">Thu</div>
            <div class="day-name">Fri</div>
            <div class="day-name">Sat</div>
        `;

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const taskEls = document.querySelectorAll(".task-data");
        const taskMap = {};

        taskEls.forEach(t => {
            if (!taskMap[t.dataset.date]) taskMap[t.dataset.date] = [];
            taskMap[t.dataset.date].push(t.dataset.title);
        });

        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            let html = `<div class="calendar-day"><strong>${day}</strong>`;
            if (taskMap[dateStr]) {
                taskMap[dateStr].forEach(t => {
                    html += `<div class="calendar-task">${t}</div>`;
                });
            }
            html += `</div>`;
            grid.innerHTML += html;
        }
    }
    function toggleExportDropdown(event) {
    event.stopPropagation();
    document.querySelector(".export-dropdown")
        .classList.toggle("show");
}

document.addEventListener("click", function () {
    const dropdown = document.querySelector(".export-dropdown");
    if (dropdown) dropdown.classList.remove("show");
});

</script>

</body>
</html>
