<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Tasks</title>

    <style>
        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #ffffff;
            color: #111827;
        }

        main { padding: 20px 32px 40px; }


        .top-bar {
            max-width: 1100px;
            margin: 0 auto 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }


        .summary-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 18px;
        }

        .summary-card {
            padding: 18px 20px;
            border-radius: 18px;
            text-align: center;
            font-weight: 800;
            box-shadow: 0 8px 18px rgba(0,0,0,0.12);
            min-width: 150px;
        }

        .summary-card h2 {
            margin: 0;
            font-size: 32px;
        }

        .summary-card span {
            display: block;
            margin-top: 6px;
            font-size: 14px;
            color: #374151;
        }

        .pending { background: #ffe4ef; }
        .progress { background: #e6f7ff; }
        .done { background: #ede9fe; }


        .calendar-btn {
            padding: 12px 22px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            color: white;
            font-weight: 800;
            font-size: 15px;
            cursor: pointer;
            box-shadow: 0 8px 18px rgba(79,70,229,0.35);
        }


        .calendar-wrapper {
            max-width: 900px;
            margin: 0 auto 32px;
            padding: 18px;
            border-radius: 20px;
            background: #ffffff;
            box-shadow: 0 12px 26px rgba(0,0,0,0.12);
            display: none;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .calendar-header h3 {
            margin: 0;
            font-size: 17px;
            font-weight: 800;
        }

        .calendar-header button {
            padding: 8px 14px;
            border-radius: 12px;
            border: none;
            font-weight: 800;
            cursor: pointer;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .day-name {
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            color: #6b7280;
        }

        .calendar-day {
            min-height: 85px;
            padding: 8px;
            border-radius: 12px;
            background: #f9fafb;
            font-size: 12px;
            box-shadow: inset 0 0 0 1px #e5e7eb;
        }

        .calendar-day strong {
            font-size: 13px;
            display: block;
            margin-bottom: 6px;
        }

        .calendar-task {
            background: #eef2ff;
            border-radius: 8px;
            padding: 4px 6px;
            margin-bottom: 4px;
            font-size: 11px;
        }


        .controls {
            max-width: 1100px;
            margin: 0 auto 36px;
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 22px;
            border-radius: 20px;
            background: #ffffff;
            box-shadow: 0 10px 24px rgba(0,0,0,0.08);
        }

        .controls input,
        .controls select {
            padding: 11px 18px;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            font-size: 14px;
        }

        .btn-primary {
            padding: 11px 22px;
            border-radius: 999px;
            border: none;
            background: #4f46e5;
            color: white;
            font-weight: 700;
        }

        .btn-secondary {
            padding: 11px 22px;
            border-radius: 999px;
            background: #eef2ff;
            color: #4f46e5;
            font-weight: 700;
            text-decoration: none;
        }


        .task-list {
            max-width: 1200px;
            margin: auto;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 26px;
        }

        .task-card {
            padding: 24px;
            border-radius: 22px;
            background: #e6dcff;
            box-shadow: 0 10px 24px rgba(0,0,0,0.14);
        }

        .task-card.completed {
            background: #f4f1ff;
            opacity: 0.95;
        }

        .title { font-size: 17px; font-weight: 800; }
        .description { font-size: 14px; margin-bottom: 10px; color: #374151; }
        .meta { font-size: 13px; margin-bottom: 4px; color: #6b7280; }

        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            background: rgba(255,255,255,0.7);
            margin-right: 6px;
        }

        .actions {
            margin-top: 14px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .actions a {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 999px;
            font-weight: 700;
            background: #ffffff;
            color: #4f46e5;
            text-decoration: none;
        }


        .pagination {
            margin-top: 44px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .pagination a {
            padding: 10px 18px;
            background: #eef2ff;
            color: #4f46e5;
            border-radius: 999px;
            text-decoration: none;
            font-weight: 700;
        }

        .pagination a.active {
            background: #4f46e5;
            color: white;
        }

#successPopup {
    position: fixed;
    top: 30px;
    right: 30px;
    background: #22c55e;
    color: white;
    padding: 14px 22px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 15px 30px rgba(0,0,0,0.2);
    z-index: 9999;

    opacity: 0;
    transform: translateY(-20px);
    animation: slideIn 0.4s ease forwards;
}

@keyframes slideIn {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeOut {
    to {
        opacity: 0;
        transform: translateY(-10px);
    }
}

    </style>
</head>

<body>

<div id="successPopup" th:if="${success}">
    ‚úî <span th:text="${success}"></span>
</div>

<div th:replace="fragments/header :: header"></div>

<main>


    <div class="top-bar">
        <div class="summary-cards">
            <div class="summary-card pending">
                <h2 th:text="${pendingCount}">0</h2>
                <span>‚è≥ Pending</span>
            </div>
            <div class="summary-card progress">
                <h2 th:text="${inProgressCount}">0</h2>
                <span>üîÑ In Progress</span>
            </div>
            <div class="summary-card done">
                <h2 th:text="${doneCount}">0</h2>
                <span>‚úÖ Completed</span>
            </div>
        </div>

        <button class="calendar-btn" onclick="toggleCalendar()">üìÖ Calendar</button>
    </div>


    <div class="calendar-wrapper" id="calendarWrapper">
        <div class="calendar-header">
            <button onclick="changeMonth(-1)">‚óÄ</button>
            <h3 id="monthTitle"></h3>
            <button onclick="changeMonth(1)">‚ñ∂</button>
        </div>

        <div class="calendar-grid" id="calendarGrid">
            <div class="day-name">Sun</div>
            <div class="day-name">Mon</div>
            <div class="day-name">Tue</div>
            <div class="day-name">Wed</div>
            <div class="day-name">Thu</div>
            <div class="day-name">Fri</div>
            <div class="day-name">Sat</div>
        </div>
    </div>


    <div class="controls">
        <form action="/tasks/search" method="get">
            <input type="text" name="keyword" placeholder="Search task">
            <button class="btn-primary">Search</button>
        </form>

        <form action="/tasks/filter/status" method="get">
            <select name="status" onchange="this.form.submit()">
                <option value="">Status</option>
                <option value="PENDING">Pending</option>
                <option value="IN_PROGRESS">In Progress</option>
                <option value="COMPLETED">Completed</option>
            </select>
        </form>

        <form action="/tasks/filter/priority" method="get">
            <select name="priority" onchange="this.form.submit()">
                <option value="">Priority</option>
                <option value="LOW">Low</option>
                <option value="MEDIUM">Medium</option>
                <option value="HIGH">High</option>
            </select>
        </form>

        <a href="/tasks" class="btn-secondary">Clear Filters</a>
    </div>


    <div class="task-list">
        <div class="task-card"
             th:each="task : ${tasks}"
             th:classappend="${task.status != null and task.status.name() == 'COMPLETED'} ? 'completed'">

            <div class="title" th:text="${task.title}"></div>
            <div class="description" th:text="${task.description}"></div>

            <div class="meta">Due date: <b th:text="${task.dueDate}"></b></div>

            <div class="meta" th:if="${task.createdAt != null}">
                Created at:
                <b th:text="${#temporals.format(task.createdAt,'dd-MM-yyyy HH:mm')}"></b>
            </div>

            <div class="meta" th:if="${task.completedAt != null}">
                Completed at:
                <b th:text="${#temporals.format(task.completedAt,'dd-MM-yyyy HH:mm')}"></b>
            </div>

            <span class="badge" th:text="${task.status}"></span>
            <span class="badge" th:text="${task.priority}"></span>

            <div class="actions">
                <a th:if="${task.status.name() != 'COMPLETED'}"
                   th:href="@{'/tasks/complete/' + ${task.id}}">Complete</a>
                <a th:href="@{'/tasks/view/' + ${task.id}}">View</a>
                <a th:if="${task.status.name() != 'COMPLETED'}"
                   th:href="@{'/tasks/edit/' + ${task.id}}">Edit</a>
                <a th:href="@{'/tasks/delete/' + ${task.id}}"
                   onclick="return confirm('Delete this task?')">Delete</a>
            </div>

            <span class="task-data"
                  th:data-date="${task.dueDate}"
                  th:data-title="${task.title}"
                  style="display:none"></span>
        </div>
    </div>


    <div class="pagination" th:if="${totalPages > 1}">
        <a th:each="i : ${#numbers.sequence(0, totalPages-1)}"
           th:href="@{/tasks(page=${i})}"
           th:text="${i + 1}"
           th:classappend="${i == currentPage} ? 'active'"></a>
    </div>

</main>

<div th:replace="fragments/footer :: footer"></div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const popup = document.getElementById("successPopup");

        if (popup) {
            setTimeout(() => {
                popup.style.animation = "fadeOut 0.4s ease forwards";
            }, 3000);

            setTimeout(() => {
                popup.remove();
            }, 3500);
        }
    });
    let currentDate = new Date();

    function toggleCalendar() {
        const cal = document.getElementById("calendarWrapper");
        cal.style.display = cal.style.display === "none" ? "block" : "none";
        renderCalendar();
    }

    function changeMonth(step) {
        currentDate.setMonth(currentDate.getMonth() + step);
        renderCalendar();
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        const monthNames = [
            "January","February","March","April","May","June",
            "July","August","September","October","November","December"
        ];

        document.getElementById("monthTitle").innerText =
            monthNames[month] + " " + year;

        const grid = document.getElementById("calendarGrid");
        grid.innerHTML = `
            <div class="day-name">Sun</div>
            <div class="day-name">Mon</div>
            <div class="day-name">Tue</div>
            <div class="day-name">Wed</div>
            <div class="day-name">Thu</div>
            <div class="day-name">Fri</div>
            <div class="day-name">Sat</div>
        `;

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const taskEls = document.querySelectorAll(".task-data");
        const taskMap = {};

        taskEls.forEach(t => {
            if (!taskMap[t.dataset.date]) taskMap[t.dataset.date] = [];
            taskMap[t.dataset.date].push(t.dataset.title);
        });

        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            let html = `<div class="calendar-day"><strong>${day}</strong>`;
            if (taskMap[dateStr]) {
                taskMap[dateStr].forEach(t => {
                    html += `<div class="calendar-task">${t}</div>`;
                });
            }
            html += `</div>`;
            grid.innerHTML += html;
        }
    }
</script>

</body>
</html>